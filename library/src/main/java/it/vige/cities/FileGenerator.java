package it.vige.cities;

import static java.lang.System.getProperty;
import static java.util.Locale.getDefault;
import static org.slf4j.LoggerFactory.getLogger;

import java.io.File;

import org.slf4j.Logger;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;

import it.vige.cities.result.Nodes;

/**
 * Generator through file
 * @author lucastancapiano
 */
public class FileGenerator {

	/**
	 * Folder home
	 */
	public final static String CITIES_HOME = getProperty("user.home") + "/cities-generator/";

	/**
	 * Version of cities-generator
	 * Reads from manifest Implementation-Version, or defaults to "unknown" if not available
	 */
	public final static String VERSION = getVersion();
	
	/**
	 * Get version from manifest or properties file or default
	 * @return the version string
	 */
	private static String getVersion() {
		String version = null;
		
		// First try: Package Implementation-Version (works when running from JAR)
		version = FileGenerator.class.getPackage().getImplementationVersion();
		
		// Second try: Read from version.properties file (works during tests and development)
		if (version == null || version.isEmpty()) {
			try {
				java.io.InputStream is = FileGenerator.class.getResourceAsStream("/it/vige/cities/version.properties");
				if (is != null) {
					java.util.Properties props = new java.util.Properties();
					props.load(is);
					version = props.getProperty("version");
					is.close();
				}
			} catch (Exception e) {
				// Ignore
			}
		}
		
		// Third try: Read from manifest directly (fallback)
		if (version == null || version.isEmpty()) {
			try {
				java.net.URL url = FileGenerator.class.getProtectionDomain().getCodeSource().getLocation();
				if (url != null) {
					java.util.jar.JarFile jarFile = new java.util.jar.JarFile(new java.io.File(url.toURI()));
					java.util.jar.Manifest manifest = jarFile.getManifest();
					if (manifest != null) {
						version = manifest.getMainAttributes().getValue("Implementation-Version");
					}
					jarFile.close();
				}
			} catch (Exception e) {
				// Ignore
			}
		}
		
		return version != null && !version.isEmpty() ? version : "unknown";
	}

	/**
	 * Country
	 */
	protected String country = getDefault().getCountry().toLowerCase();

	private Logger logger = getLogger(FileGenerator.class);

	private ObjectMapper mapper = new ObjectMapper();
	
	/**
	 * default fileGenerator
	 */
	public FileGenerator() {
		
	}

	/**
	 * Write file
	 * @param nodes the nodes to write
	 * @throws Exception if there is a problem
	 */
	protected void writeFile(Nodes nodes) throws Exception {
		writeFile(nodes, null);
	}

	/**
	 * Write file
	 * @param nodes the nodes to write
	 * @param templateName the name of the template used to generate the data
	 * @throws Exception if there is a problem
	 */
	protected void writeFile(Nodes nodes, String templateName) throws Exception {
		new File(CITIES_HOME).mkdir();
		String name = CITIES_HOME + country + ".json";
		
		// Serialize nodes to JSON
		JsonNode jsonNode = mapper.valueToTree(nodes);
		
		// Add copyright as first field
		ObjectNode objectNode = (ObjectNode) jsonNode;
		String copyright = "Generated by cities-generator maintained by Vige community, version " + VERSION;
		if (templateName != null && !templateName.isEmpty()) {
			copyright += ", template: " + templateName;
		}
		copyright += ". Copyright (c) Vige, Home of Professional Open Source. Licensed under the Apache License, Version 2.0.";
		ObjectNode newObjectNode = mapper.createObjectNode();
		newObjectNode.put("copyright", copyright);
		newObjectNode.setAll(objectNode);
		
		// Write the modified JSON to file
		mapper.writeValue(new File(name), newObjectNode);
		logger.info(mapper.writeValueAsString(newObjectNode));
		logger.info("File generated in " + name);
	}

	/**
	 * Read file
	 * @return the read nodes
	 * @throws Exception if there is a problem
	 */
	protected Nodes readFile() throws Exception {
		return readFile(country);
	}

	/**
	 * Read file
	 * @param country the country
	 * @return the nodes of the country
	 * @throws Exception if there is a problem
	 */
	protected Nodes readFile(String country) throws Exception {
		new File(CITIES_HOME).mkdir();
		return mapper.readValue(new File(CITIES_HOME + country + ".json"), Nodes.class);
	}

	/**
	 * Exists
	 * @return true if the file exists
	 */
	protected boolean exists() {
		return new File(CITIES_HOME).exists() && new File(CITIES_HOME + country + ".json").exists();
	}

}
