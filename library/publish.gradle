publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
            versionMapping {
                usage('java-api') {
                    fromResolutionOf('runtimeClasspath')
                }
                usage('java-runtime') {
                    fromResolutionResult()
                }
            }
            pom {
                name = 'Cities Generator'
                description = 'Generate a file with the cities of your country'
                url = 'http://cities-generator.vige.it'
                properties = [
                    'maven.compiler.source': "${javaVersion.majorVersion}",
                    'maven.compiler.target': "${javaVersion.majorVersion}"
                ]
                licenses {
                    license {
                        name = 'The Apache License, Version 2.0'
                        url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                    }
                }
                developers {
                    developer {
                        id = 'flashboss'
                        name = 'Luca Stancapiano'
                        email = 'luca.stancapiano@vige.it'
                        organization = 'vige'
                        organizationUrl = 'http://www.vige.it'
                        url = 'http://www.vige.it'
                    }
                }
                scm {
                    connection = 'scm:git:https://github.com/flashboss/cities-generator.git'
                    developerConnection = 'scm:git:https://github.com/flashboss/cities-generator.git'
                    tag = '1.1.3'
                    url = 'https://github.com/flashboss/cities-generator'
                }
            }
        }
    }
}

signing {
    useGpgCmd()
    sign publishing.publications.mavenJava
}

// Task to generate checksums for artifacts
task generateChecksums {
    dependsOn 'jar', 'javadocJar', 'sourcesJar', 'generatePomFileForMavenJavaPublication'
    
    def artifactBaseName = 'cities-generator'
    def artifactVersion = version
    def libsDirPath = "${buildDir}/libs"
    def pomFilePath = "${buildDir}/publications/mavenJava/pom-default.xml"
    
    doLast {
        def libsDir = new File(libsDirPath)
        // Maven Central requires MD5 and SHA-1 checksums
        def algorithms = ['SHA-1', 'MD5']
        
        // Generate checksums for JARs
        [".jar", "-sources.jar", "-javadoc.jar"].each { suffix ->
            def jarFile = new File(libsDir, "${artifactBaseName}-${artifactVersion}${suffix}")
            if (jarFile.exists()) {
                algorithms.each { algorithm ->
                    def digest = java.security.MessageDigest.getInstance(algorithm)
                    jarFile.withInputStream { input ->
                        def buffer = new byte[4096]
                        int bytesRead
                        while ((bytesRead = input.read(buffer)) != -1) {
                            digest.update(buffer, 0, bytesRead)
                        }
                    }
                    def hashBytes = digest.digest()
                    def hash = hashBytes.collect { String.format("%02x", it) }.join('')
                    
                    def checksumFile = new File(jarFile.parent, "${jarFile.name}.${algorithm.toLowerCase().replace('-', '')}")
                    checksumFile.text = hash
                }
            }
        }
        
        // Generate checksums for POM
        def pomFile = new File(pomFilePath)
        if (pomFile.exists()) {
            algorithms.each { algorithm ->
                def digest = java.security.MessageDigest.getInstance(algorithm)
                pomFile.withInputStream { input ->
                    def buffer = new byte[4096]
                    int bytesRead
                    while ((bytesRead = input.read(buffer)) != -1) {
                        digest.update(buffer, 0, bytesRead)
                    }
                }
                def hashBytes = digest.digest()
                def hash = hashBytes.collect { String.format("%02x", it) }.join('')
                
                def checksumFile = new File(pomFile.parent, "${pomFile.name}.${algorithm.toLowerCase().replace('-', '')}")
                checksumFile.text = hash
            }
        }
    }
}

// Task to create ZIP bundle for manual publication on Central Publishing
task createPublishBundle(type: Zip) {
    dependsOn 'jar', 'javadocJar', 'sourcesJar', 'signMavenJavaPublication', 'generatePomFileForMavenJavaPublication', 'generateChecksums'
    
    def artifactBaseName = 'cities-generator'
    def artifactVersion = version
    def mavenPath = "${project.group.toString().replace('.', '/')}/${artifactBaseName}/${artifactVersion}"
    
    archiveBaseName = "${artifactBaseName}-bundle"
    archiveVersion = "${artifactVersion}"
    archiveExtension = 'zip'
    destinationDirectory = file("${buildDir}/distributions")
    
    // Include JAR, signatures and checksums from build/libs into Maven directory structure
    from("${buildDir}/libs") {
        include "${artifactBaseName}-${artifactVersion}.jar"
        include "${artifactBaseName}-${artifactVersion}.jar.asc"
        include "${artifactBaseName}-${artifactVersion}.jar.sha1"
        include "${artifactBaseName}-${artifactVersion}.jar.md5"
        include "${artifactBaseName}-${artifactVersion}-sources.jar"
        include "${artifactBaseName}-${artifactVersion}-sources.jar.asc"
        include "${artifactBaseName}-${artifactVersion}-sources.jar.sha1"
        include "${artifactBaseName}-${artifactVersion}-sources.jar.md5"
        include "${artifactBaseName}-${artifactVersion}-javadoc.jar"
        include "${artifactBaseName}-${artifactVersion}-javadoc.jar.asc"
        include "${artifactBaseName}-${artifactVersion}-javadoc.jar.sha1"
        include "${artifactBaseName}-${artifactVersion}-javadoc.jar.md5"
        into mavenPath
    }
    
    // Include POM, signature and checksums from build/publications/mavenJava with rename into Maven directory structure
    from("${buildDir}/publications/mavenJava") {
        include "pom-default.xml"
        include "pom-default.xml.asc"
        include "pom-default.xml.sha1"
        include "pom-default.xml.md5"
        rename "pom-default.xml", "${artifactBaseName}-${artifactVersion}.pom"
        rename "pom-default.xml.asc", "${artifactBaseName}-${artifactVersion}.pom.asc"
        rename "pom-default.xml.sha1", "${artifactBaseName}-${artifactVersion}.pom.sha1"
        rename "pom-default.xml.md5", "${artifactBaseName}-${artifactVersion}.pom.md5"
        into mavenPath
    }
    
    doLast {
        def bundleFile = archiveFile.get().asFile
        println "\nâœ… Bundle created: ${bundleFile}"
        println "ðŸ“¦ Size: ${bundleFile.length() / 1024} KB"
        println "ðŸ“¦ Files included:"
        println "   - cities-generator-${artifactVersion}.jar + .asc + .sha1 + .md5"
        println "   - cities-generator-${artifactVersion}-sources.jar + .asc + .sha1 + .md5"
        println "   - cities-generator-${artifactVersion}-javadoc.jar + .asc + .sha1 + .md5"
        println "   - cities-generator-${artifactVersion}.pom + .asc + .sha1 + .md5"
    }
}

// Execute createPublishBundle after publishToMavenLocal
tasks.named('publishToMavenLocal') {
    finalizedBy 'createPublishBundle'
}

